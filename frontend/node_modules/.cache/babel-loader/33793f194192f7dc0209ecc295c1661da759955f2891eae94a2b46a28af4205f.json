{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useEffect, useCallback, useRef } from 'react';\nimport { getCityCoordinates, getWeatherData, getAirQualityData } from '../../../services/weather';\nimport api from '../../../services/api';\nexport default function useMapData(city, country, user) {\n  _s();\n  const [weather, setWeather] = useState(null);\n  const [airQuality, setAirQuality] = useState(null);\n  const [feedbacks, setFeedbacks] = useState([]);\n  const [markers, setMarkers] = useState([]);\n  const prevSearchRef = useRef('');\n\n  // Map feedback → marker objects\n  const updateMarkers = useCallback(data => {\n    const newMarkers = data.map(f => ({\n      id: f.id,\n      position: {\n        lat: typeof f.latitude === 'number' ? f.latitude : parseFloat(f.latitude),\n        lng: typeof f.longitude === 'number' ? f.longitude : parseFloat(f.longitude)\n      },\n      type: f.issue_type || f.issueType,\n      severity: f.severity\n    }));\n    setMarkers(newMarkers);\n  }, []);\n\n  // Load from backend\n  const fetchFeedbackReports = useCallback(async () => {\n    try {\n      const resp = await api.get(`/api/feedback/?city=${encodeURIComponent(city)}`, {\n        headers: user ? {\n          Authorization: `Token ${localStorage.getItem('token')}`\n        } : {}\n      });\n      setFeedbacks(resp.data);\n      updateMarkers(resp.data);\n    } catch (err) {\n      console.error('Error loading feedback:', err);\n      setFeedbacks([]);\n      setMarkers([]);\n    }\n  }, [city, user, updateMarkers]);\n\n  // Master fetch for weather, air quality, feedback\n  const fetchData = useCallback(async () => {\n    if (!city && !country) return {\n      center: null,\n      zoom: null\n    };\n    const key = `${city}|${country}`;\n    if (prevSearchRef.current === key) return {\n      center: null,\n      zoom: null\n    };\n    prevSearchRef.current = key;\n    try {\n      const {\n        lat,\n        lon\n      } = await getCityCoordinates(city, country);\n      const [w, a] = await Promise.all([getWeatherData(lat, lon), getAirQualityData(lat, lon).catch(e => {\n        console.error(e);\n        return null;\n      })]);\n      setWeather(w);\n      setAirQuality(a);\n      await fetchFeedbackReports();\n      return {\n        center: {\n          lat,\n          lng: lon\n        },\n        zoom: city ? 13 : 6\n      };\n    } catch (err) {\n      console.error('Map data error:', err);\n      throw err;\n    }\n  }, [city, country, fetchFeedbackReports]);\n  useEffect(() => {\n    fetchData();\n  }, [fetchData]);\n  return {\n    weather,\n    airQuality,\n    feedbacks,\n    markers,\n    fetchData\n  };\n}\n_s(useMapData, \"YZzgLv60ln7+MkwlNQMRtkwZEts=\");","map":{"version":3,"names":["useState","useEffect","useCallback","useRef","getCityCoordinates","getWeatherData","getAirQualityData","api","useMapData","city","country","user","_s","weather","setWeather","airQuality","setAirQuality","feedbacks","setFeedbacks","markers","setMarkers","prevSearchRef","updateMarkers","data","newMarkers","map","f","id","position","lat","latitude","parseFloat","lng","longitude","type","issue_type","issueType","severity","fetchFeedbackReports","resp","get","encodeURIComponent","headers","Authorization","localStorage","getItem","err","console","error","fetchData","center","zoom","key","current","lon","w","a","Promise","all","catch","e"],"sources":["C:/MNNIT/SEM2/programmingLab2/Project/smartcity/smartCity/frontend/src/components/Map/hooks/useMapData.js"],"sourcesContent":["import { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { getCityCoordinates, getWeatherData, getAirQualityData } from '../../../services/weather';\r\nimport api from '../../../services/api';\r\n\r\nexport default function useMapData(city, country, user) {\r\n  const [weather, setWeather] = useState(null);\r\n  const [airQuality, setAirQuality] = useState(null);\r\n  const [feedbacks, setFeedbacks] = useState([]);\r\n  const [markers, setMarkers] = useState([]);\r\n  const prevSearchRef = useRef('');\r\n\r\n  // Map feedback → marker objects\r\n  const updateMarkers = useCallback(data => {\r\n    const newMarkers = data.map(f => ({\r\n      id: f.id,\r\n      position: {\r\n        lat: typeof f.latitude === 'number' ? f.latitude : parseFloat(f.latitude),\r\n        lng: typeof f.longitude === 'number' ? f.longitude : parseFloat(f.longitude)\r\n      },\r\n      type: f.issue_type || f.issueType,\r\n      severity: f.severity\r\n    }));\r\n    setMarkers(newMarkers);\r\n  }, []);\r\n\r\n  // Load from backend\r\n  const fetchFeedbackReports = useCallback(async () => {\r\n    try {\r\n      const resp = await api.get(`/api/feedback/?city=${encodeURIComponent(city)}`, {\r\n        headers: user ? { Authorization: `Token ${localStorage.getItem('token')}` } : {}\r\n      });\r\n      setFeedbacks(resp.data);\r\n      updateMarkers(resp.data);\r\n    } catch (err) {\r\n      console.error('Error loading feedback:', err);\r\n      setFeedbacks([]);\r\n      setMarkers([]);\r\n    }\r\n  }, [city, user, updateMarkers]);\r\n\r\n  // Master fetch for weather, air quality, feedback\r\n  const fetchData = useCallback(async () => {\r\n    if (!city && !country) return { center: null, zoom: null };\r\n    const key = `${city}|${country}`;\r\n    if (prevSearchRef.current === key) return { center: null, zoom: null };\r\n    prevSearchRef.current = key;\r\n\r\n    try {\r\n      const { lat, lon } = await getCityCoordinates(city, country);\r\n      const [w, a] = await Promise.all([\r\n        getWeatherData(lat, lon),\r\n        getAirQualityData(lat, lon).catch(e => { console.error(e); return null; })\r\n      ]);\r\n      setWeather(w);\r\n      setAirQuality(a);\r\n      await fetchFeedbackReports();\r\n      return { center: { lat, lng: lon }, zoom: city ? 13 : 6 };\r\n    } catch (err) {\r\n      console.error('Map data error:', err);\r\n      throw err;\r\n    }\r\n  }, [city, country, fetchFeedbackReports]);\r\n\r\n  useEffect(() => { fetchData(); }, [fetchData]);\r\n\r\n  return { weather, airQuality, feedbacks, markers, fetchData };\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}